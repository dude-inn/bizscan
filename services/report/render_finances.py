# -*- coding: utf-8 -*-
"""
Рендер секции с финансовой отчётностью
"""
from typing import Dict, Any, List
from .formatters import format_money, clean_text
from .flattener import flatten, apply_aliases


def render_finances(data: Dict[str, Any], extended: bool = True) -> str:
    """
    Рендерит финансовую отчётность
    
    Args:
        data: Финансовые данные
        extended: Расширенная форма
        
    Returns:
        Финансовая отчётность
    """
    lines = []
    
    if not data or 'data' not in data:
        return "—"
    
    data_section = data['data']
    if not data_section:
        return "—"
    
    # Получаем все доступные годы
    years = []
    for key in data_section.keys():
        if key.isdigit() and len(key) == 4:
            years.append(int(key))
    
    if not years:
        return "—"
    
    years.sort(reverse=True)  # Сортируем по убыванию
    
    # Показываем только последние 5 лет
    years = years[:5]
    
    for year in years:
        year_data = data_section[str(year)]
        lines.append(f"\nГод: {year}")
        lines.append("-" * 30)
        
        # Сначала выводим основные показатели если есть
        revenue = year_data.get('2110', 0)
        profit = year_data.get('2400', 0)
        
        if revenue > 0:
            lines.append(f"Выручка (2110): {format_money(revenue)}")
        if profit != 0:
            lines.append(f"Чистая прибыль/убыток (2400): {format_money(profit)}")
        
        # Показываем ВСЕ строки отчётности
        report_lines = []
        for key, value in year_data.items():
            if isinstance(value, (int, float)):
                # Пытаемся найти человекочитаемое название
                line_name = get_finance_line_name(key)
                report_lines.append((line_name, value))
        
        # Сортируем по убыванию суммы
        report_lines.sort(key=lambda x: abs(x[1]), reverse=True)
        
        # Показываем ВСЕ строки (не только топ-10)
        for line_name, amount in report_lines:
            lines.append(f"{line_name}: {format_money(amount)}")
    
    return "\n".join(lines)


def get_finance_line_name(code: str) -> str:
    """
    Возвращает человекочитаемое название строки отчётности
    
    Args:
        code: Код строки
        
    Returns:
        Название строки
    """
    finance_codes = {
        # ОТЧЁТ О ПРИБЫЛЯХ И УБЫТКАХ
        '2110': 'Выручка (2110)',
        '2120': 'Себестоимость продаж (2120)',
        '2100': 'Валовая прибыль (убыток) (2100)',
        '2210': 'Коммерческие расходы (2210)',
        '2220': 'Управленческие расходы (2220)',
        '2200': 'Прибыль (убыток) от продаж (2200)',
        '2310': 'Доходы от участия в других организациях (2310)',
        '2320': 'Проценты к получению (2320)',
        '2330': 'Проценты к уплате (2330)',
        '2340': 'Прочие доходы (2340)',
        '2350': 'Прочие расходы (2350)',
        '2300': 'Прибыль (убыток) до налогообложения (2300)',
        '2410': 'Налог на прибыль (2410)',
        '2421': 'Постоянные налоговые обязательства (2421)',
        '2430': 'Изменение отложенных налоговых обязательств (2430)',
        '2450': 'Изменение отложенных налоговых активов (2450)',
        '2460': 'Прочее (2460)',
        '2400': 'Чистая прибыль (убыток) (2400)',
        '2500': 'Совокупный финансовый результат периода (2500)',
        '2510': 'Результат от переоценки внеоборотных активов (2510)',
        '2520': 'Результат от прочих операций (2520)',
        '2530': 'Налог на прибыль от операций (2530)',
        
        # БАЛАНС - АКТИВЫ
        '1100': 'Внеоборотные активы (1100)',
        '1110': 'Нематериальные активы (1110)',
        '1120': 'Результаты исследований и разработок (1120)',
        '1130': 'Нематериальные поисковые активы (1130)',
        '1140': 'Материальные поисковые активы (1140)',
        '1150': 'Основные средства (1150)',
        '1160': 'Доходные вложения в материальные ценности (1160)',
        '1170': 'Финансовые вложения (1170)',
        '1180': 'Отложенные налоговые активы (1180)',
        '1190': 'Прочие внеоборотные активы (1190)',
        '1200': 'Оборотные активы (1200)',
        '1210': 'Запасы (1210)',
        '1220': 'НДС по приобретённым ценностям (1220)',
        '1230': 'Дебиторская задолженность (1230)',
        '1240': 'Финансовые вложения (за исключением денежных эквивалентов) (1240)',
        '1250': 'Денежные средства и денежные эквиваленты (1250)',
        '1260': 'Прочие оборотные активы (1260)',
        '1600': 'БАЛАНС (актив) (1600)',
        '1700': 'БАЛАНС (пассив) (1700)',
        
        # БАЛАНС - ПАССИВЫ
        '1300': 'Капитал и резервы (1300)',
        '1310': 'Уставный капитал (1310)',
        '1320': 'Собственные акции, выкупленные у акционеров (1320)',
        '1340': 'Переоценка внеоборотных активов (1340)',
        '1350': 'Добавочный капитал (без переоценки) (1350)',
        '1360': 'Резервный капитал (1360)',
        '1370': 'Нераспределённая прибыль (непокрытый убыток) (1370)',
        '1400': 'Долгосрочные обязательства (1400)',
        '1410': 'Заёмные средства (1410)',
        '1420': 'Отложенные налоговые обязательства (1420)',
        '1430': 'Оценочные обязательства (1430)',
        '1450': 'Прочие обязательства (1450)',
        '1500': 'Краткосрочные обязательства (1500)',
        '1510': 'Заёмные средства (1510)',
        '1520': 'Кредиторская задолженность (1520)',
        '1530': 'Доходы будущих периодов (1530)',
        '1540': 'Оценочные обязательства (1540)',
        '1550': 'Прочие обязательства (1550)',
        
        # ОТЧЁТ О ДВИЖЕНИИ ДЕНЕЖНЫХ СРЕДСТВ
        '4100': 'Поступления от продажи товаров, работ, услуг (4100)',
        '4110': 'Поступления от продажи товаров, работ, услуг (4110)',
        '4111': 'Поступления от продажи товаров, работ, услуг (4111)',
        '4112': 'Поступления от продажи товаров, работ, услуг (4112)',
        '4113': 'Поступления от продажи товаров, работ, услуг (4113)',
        '4119': 'Поступления от продажи товаров, работ, услуг (4119)',
        '4120': 'Поступления от продажи товаров, работ, услуг (4120)',
        '4121': 'Поступления от продажи товаров, работ, услуг (4121)',
        '4122': 'Поступления от продажи товаров, работ, услуг (4122)',
        '4123': 'Поступления от продажи товаров, работ, услуг (4123)',
        '4124': 'Поступления от продажи товаров, работ, услуг (4124)',
        '4129': 'Поступления от продажи товаров, работ, услуг (4129)',
        '4200': 'Поступления от продажи товаров, работ, услуг (4200)',
        '4210': 'Поступления от продажи товаров, работ, услуг (4210)',
        '4211': 'Поступления от продажи товаров, работ, услуг (4211)',
        '4212': 'Поступления от продажи товаров, работ, услуг (4212)',
        '4213': 'Поступления от продажи товаров, работ, услуг (4213)',
        '4214': 'Поступления от продажи товаров, работ, услуг (4214)',
        '4219': 'Поступления от продажи товаров, работ, услуг (4219)',
        '4220': 'Поступления от продажи товаров, работ, услуг (4220)',
        '4221': 'Поступления от продажи товаров, работ, услуг (4221)',
        '4222': 'Поступления от продажи товаров, работ, услуг (4222)',
        '4223': 'Поступления от продажи товаров, работ, услуг (4223)',
        '4224': 'Поступления от продажи товаров, работ, услуг (4224)',
        '4229': 'Поступления от продажи товаров, работ, услуг (4229)',
        '4300': 'Поступления от продажи товаров, работ, услуг (4300)',
        '4310': 'Поступления от продажи товаров, работ, услуг (4310)',
        '4311': 'Поступления от продажи товаров, работ, услуг (4311)',
        '4312': 'Поступления от продажи товаров, работ, услуг (4312)',
        '4313': 'Поступления от продажи товаров, работ, услуг (4313)',
        '4314': 'Поступления от продажи товаров, работ, услуг (4314)',
        '4319': 'Поступления от продажи товаров, работ, услуг (4319)',
        '4320': 'Поступления от продажи товаров, работ, услуг (4320)',
        '4321': 'Поступления от продажи товаров, работ, услуг (4321)',
        '4322': 'Поступления от продажи товаров, работ, услуг (4322)',
        '4323': 'Поступления от продажи товаров, работ, услуг (4323)',
        '4329': 'Поступления от продажи товаров, работ, услуг (4329)',
        '4400': 'Поступления от продажи товаров, работ, услуг (4400)',
        '4450': 'Поступления от продажи товаров, работ, услуг (4450)',
        '4490': 'Поступления от продажи товаров, работ, услуг (4490)',
        '4500': 'Поступления от продажи товаров, работ, услуг (4500)',
        
        # ОТЧЁТ ОБ ИЗМЕНЕНИЯХ КАПИТАЛА
        '3100': 'Остаток на 31 декабря предыдущего года (3100)',
        '3200': 'Остаток на 31 декабря года, предшествующего предыдущему (3200)',
        '3210': 'Увеличение капитала - всего (3210)',
        '3211': 'Увеличение капитала - всего (3211)',
        '3212': 'Увеличение капитала - всего (3212)',
        '3213': 'Увеличение капитала - всего (3213)',
        '3214': 'Увеличение капитала - всего (3214)',
        '3215': 'Увеличение капитала - всего (3215)',
        '3216': 'Увеличение капитала - всего (3216)',
        '3220': 'Уменьшение капитала - всего (3220)',
        '3221': 'Уменьшение капитала - всего (3221)',
        '3222': 'Уменьшение капитала - всего (3222)',
        '3223': 'Уменьшение капитала - всего (3223)',
        '3224': 'Уменьшение капитала - всего (3224)',
        '3225': 'Уменьшение капитала - всего (3225)',
        '3226': 'Уменьшение капитала - всего (3226)',
        '3227': 'Уменьшение капитала - всего (3227)',
        '3230': 'Изменение добавочного капитала (3230)',
        '3240': 'Изменение резервного капитала (3240)',
        '3300': 'Остаток на 31 декабря отчётного года (3300)',
        '3310': 'Чистая прибыль (3310)',
        '3311': 'Чистая прибыль (3311)',
        '3312': 'Чистая прибыль (3312)',
        '3313': 'Чистая прибыль (3313)',
        '3314': 'Чистая прибыль (3314)',
        '3315': 'Чистая прибыль (3315)',
        '3316': 'Чистая прибыль (3316)',
        '3320': 'Дивиденды (3320)',
        '3321': 'Дивиденды (3321)',
        '3322': 'Дивиденды (3322)',
        '3323': 'Дивиденды (3323)',
        '3324': 'Дивиденды (3324)',
        '3325': 'Дивиденды (3325)',
        '3326': 'Дивиденды (3326)',
        '3327': 'Дивиденды (3327)',
        '3330': 'Отчисления в резервный капитал (3330)',
        '3340': 'Уменьшение уставного капитала (3340)',
        '3400': 'Остаток на 31 декабря отчётного года (3400)',
        '3401': 'Остаток на 31 декабря отчётного года (3401)',
        '3402': 'Остаток на 31 декабря отчётного года (3402)',
        '3410': 'Остаток на 31 декабря отчётного года (3410)',
        '3411': 'Остаток на 31 декабря отчётного года (3411)',
        '3412': 'Остаток на 31 декабря отчётного года (3412)',
        '3420': 'Остаток на 31 декабря отчётного года (3420)',
        '3421': 'Остаток на 31 декабря отчётного года (3421)',
        '3422': 'Остаток на 31 декабря отчётного года (3422)',
        '3500': 'Остаток на 31 декабря отчётного года (3500)',
        '3501': 'Остаток на 31 декабря отчётного года (3501)',
        '3502': 'Остаток на 31 декабря отчётного года (3502)',
        '3600': 'Остаток на 31 декабря отчётного года (3600)',
        
        # ПРОЧИЕ КОДЫ
        '2900': 'Прочие (2900)',
        '2910': 'Прочие (2910)',
        '6100': 'Прочие (6100)',
        '6200': 'Прочие (6200)',
        '6210': 'Прочие (6210)',
        '6215': 'Прочие (6215)',
        '6220': 'Прочие (6220)',
        '6230': 'Прочие (6230)',
        '6240': 'Прочие (6240)',
        '6250': 'Прочие (6250)',
        '6300': 'Прочие (6300)',
        '6310': 'Прочие (6310)',
        '6311': 'Прочие (6311)',
        '6312': 'Прочие (6312)',
        '6313': 'Прочие (6313)',
        '6320': 'Прочие (6320)',
        '6321': 'Прочие (6321)',
        '6322': 'Прочие (6322)',
        '6323': 'Прочие (6323)',
        '6324': 'Прочие (6324)',
        '6325': 'Прочие (6325)',
        '6326': 'Прочие (6326)',
        '6330': 'Прочие (6330)',
        '6350': 'Прочие (6350)',
        '6400': 'Прочие (6400)',
    }
    
    return finance_codes.get(code, f"Строка {code}")